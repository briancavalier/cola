<!DOCTYPE HTML>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<title>Array to NodeListAdapter demo</title>

<script src="../test/curl/src/curl.js"></script>

<script type="text/javascript">
curl({
	baseUrl: '../',
	paths: {
		curl: 'test/curl/src/curl'
	},
	packages: {
		cola: { location: '.', main: 'cola' },
		when: { location: 'support/when', main: 'when' }
	}
});
curl(
	[
		'cola/mediator/syncCollections',
		'cola/ArrayAdapter', 
		'cola/dom/NodeListAdapter',
		'cola/dom/NodeAdapter',
		'cola/ObjectAdapter',
		'cola/AdapterResolver',
		'when'
	], 
	function (syncCollections, ArrayAdapter, NodeListAdapter, NodeAdapter, ObjectAdapter, AdapterResolver, when) {
	"use strict";
		
		var itemNode, data;

		window.names = data = [
			{ id: 1, first: 'Brian', last: 'Cavalier' },
			{ id: 2, first: 'John', last: 'Hann' },
			{ id: 3, first: 'Ian', last: 'Cavalier' },
			{ id: 4, first: 'Scott', last: 'Andrews' },
			{ id: 5, first: 'Ilia', last: 'Gilderman' }
		];

		function getNode (id) {
			return document.getElementById(id);
		}
	
		function compareById (a, b) { return a.id - b.id; }

		function symbolizer (o) { return o && o.id; }

		function querySelector (selector, node) {
			return node.querySelector(selector);
		}
	
		function init () {
			var source, dest;

			// register adapter constructors
			AdapterResolver.register(ArrayAdapter, 'collection');
			AdapterResolver.register(NodeListAdapter, 'collection');
			AdapterResolver.register(NodeAdapter, 'object');
			AdapterResolver.register(ObjectAdapter, 'object');

			// create adapters
			source = new ArrayAdapter(data, compareById, symbolizer);
			dest = new NodeListAdapter(getNode('itemNode'), {
				comparator: compareById,
				querySelector: querySelector,
				bindings: {
					first: { node: '[name=first]', prop: 'value' },
					last: { node: '[name=last]', prop: 'value' },
					id: { node: 'label' }
				}
			});

			console.log("START");

			syncCollections(source, dest, AdapterResolver, { sync: true });

			console.log("BEFORE");

			when(dest.add({ id: 6, first: 'bob', last: 'smith' }), function() {
				console.log(arguments);
				source.forEach(function(item) {
					console.log(item.first);
				});
			});
			console.log("AFTER");

			document.getElementById('print').onclick = function(e) {
				dest.forEach(function(item) {
					console.log(item);
				});
			};

		}

		curl('domReady!', init);

	}
);
</script>
</head>
<body>

<form id="test">
	<div>
		This is not repeated.
	</div>
	<div>
		<fieldset id="itemNode">
			<label></label>
			<input name="first" value="Fred"/>
			<input name="last" value="Flinstone"/>
		</fieldset>
	</div>
	<button type="button" id="print">print</button>
</form>

</body>
</html>