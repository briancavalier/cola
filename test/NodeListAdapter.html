<!DOCTYPE HTML>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<title>NodeListAdapterList test</title>

<script src="util/doh/runner.js"></script>
<script src="test-config.js"></script>

<script type="text/javascript">
require(['cola/NodeListAdapter', 'cola/ObjectAdapter', 'domReady!'], function(NodeListAdapter, ObjectAdapter) {

	var itemNode, bindings;
	
	function getNode (id) {
		return document.getElementById(id);
	}

	function simulateEvent (node, type) {
		if (document.createEvent) {
			var evt = document.createEvent('HTMLEvents');
			evt.initEvent(type, false, true);
			node.dispatchEvent(evt);
		}
		else {
			var evt = document.createEventObject();
			node.fireEvent('on' + type, evt);
		}
	}

	function compareById (a, b) { return a.id - b.id; }


	function init () {
		// this function has to run to ensure that the browser hasn't
		// attempted to preserve form values across a browser reload
		var node, first, last;
		node = getNode('test');
		first = node.elements.first;
		last = node.elements.last;
		first.value = 'Fred';
		last.value = 'Flintstone';
		itemNode = document.getElementsByTagName('fieldset')[0];
		bindings = {
			first: { node: first, prop: 'value' },
			last: { node: last, prop: 'value' }
		};
	}

	doh.register('the basics', [
		function canHandle (doh) {
			doh.assertFalse(NodeListAdapter.canHandle(), 'undefined');
			doh.assertFalse(NodeListAdapter.canHandle(null), 'null');
			doh.assertFalse(NodeListAdapter.canHandle(function(){}), 'function');
			doh.assertFalse(NodeListAdapter.canHandle([]), 'array');
			doh.assertFalse(NodeListAdapter.canHandle({}), 'object');
			doh.assertTrue(NodeListAdapter.canHandle(getNode('test')), 'DOMNode');
		}
	]);
	doh.register('events', [
		function add (doh) {
			var node, item, adapted, dfd;
			init();
			node = itemNode;
			adapted = new NodeListAdapter(node);
			adapted.comparator = compareById;
			dfd = new doh.Deferred();
			item = new ObjectAdapter({ id: 1 });
			adapted.watch(
				function (addedItem) {
					dfd.callback(addedItem == item);
				}
			);
			adapted.add(item);
			return dfd;
		},
		function remove (doh) {
			var node, item, adapted, dfd;
			init();
			node = itemNode;
			adapted = new NodeListAdapter(node);
			adapted.comparator = compareById;
			dfd = new doh.Deferred();
			item = new ObjectAdapter({ id: 1 });
			adapted.add(item);
			adapted.watch(
				null,
				function (removedItem) {
					dfd.callback(removedItem == item);
				}
			);
			adapted.remove(item)
			return dfd;
		}
	]);

	doh.run();

});
</script>
</head>
<body>

<form id="test">
	<fieldset>
		<input name="first" value="Fred"/>
		<input name="last" value="Flinstone"/>
	</fieldset>
</form>

</body>
</html>