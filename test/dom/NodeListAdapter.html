<!DOCTYPE HTML>
<html lang="en-US">
<head>
<meta charset="UTF-8">
<title>NodeListAdapterList test</title>

<script src="../util/doh/runner.js"></script>
<script src="../test-config.js"></script>

<script type="text/javascript">
require(['cola/dom/NodeListAdapter', 'cola/ObjectAdapter', 'domReady!'], function(NodeListAdapter, ObjectAdapter) {

	var rootNode, itemNode;

	function getNode (id) {
		return document.getElementById(id);
	}

	function simulateEvent (node, type) {
		if (document.createEvent) {
			var evt = document.createEvent('HTMLEvents');
			evt.initEvent(type, false, true);
			node.dispatchEvent(evt);
		}
		else {
			var evt = document.createEventObject();
			node.fireEvent('on' + type, evt);
		}
	}

	function compareById (a, b) { return a.id - b.id; }
	function symbolizeById (a) { return a.id; }
	function querySelector (selector, node) { return (node||document).querySelector(selector); }
	function querySelectorAll (selector, node) { return (node||document).querySelectorAll(selector); }


	function init () {
		// this function has to run to ensure that the browser hasn't
		// attempted to preserve form values across a browser reload
		rootNode = getNode('test');
		itemNode = 'fieldset';
	}

	doh.register('the basics', [
		function shouldHandleNodes (doh) {
			doh.assertTrue(NodeListAdapter.canHandle(getNode('test')), 'DOMNode');
		},
		function shouldNotHandleNonNodes (doh) {
			doh.assertFalse(NodeListAdapter.canHandle(), 'undefined');
			doh.assertFalse(NodeListAdapter.canHandle(null), 'null');
			doh.assertFalse(NodeListAdapter.canHandle(function(){}), 'function');
			doh.assertFalse(NodeListAdapter.canHandle([]), 'array');
			doh.assertFalse(NodeListAdapter.canHandle({}), 'object');
		}
	]);
	doh.register('events', [
		function shouldAddNodeForEachItem (doh) {
			var item, adapted, options;
			init();
			options = {
				querySelector: querySelector,
				itemTemplateSelector: itemNode,
				comparator: compareById,
				identifier: symbolizeById
			};
			adapted = new NodeListAdapter(rootNode, options);
			item = { id: 1 };
			adapted.add(item);
			adapted.add({ id: 9 });
			adapted.add({ id: 3 });
			doh.assertEqual(3, rootNode.querySelectorAll('fieldset').length);
		},
		function shouldUpdateNode (doh) {
			var item, adapted, options;
			init();
			options = {
				querySelector: querySelector,
				itemTemplateSelector: itemNode,
				comparator: compareById,
				identifier: symbolizeById,
				bindings: {
					name: { node: '', prop: 'name' }
				}
			};
			adapted = new NodeListAdapter(rootNode, options);
			item = { id: 1, name: 'bar' };
			adapted.add(item);
			adapted.update({ id: 1, name: 'foo' });
			doh.assertEqual('foo', querySelector(itemNode).name);
		},
		function shouldRemoveNode (doh) {
			var item, adapted;
			init();
			options = {
				querySelector: querySelector,
				itemTemplateSelector: itemNode,
				comparator: compareById,
				identifier: symbolizeById
			};
			adapted = new NodeListAdapter(rootNode, options);
			rootNode.innerHTML = ''; // clear out previous tests
			item = { id: 1 };
			adapted.add(item);
			adapted.add({ id: 2 });
			adapted.add({ id: 3 });
			adapted.remove(item);
			doh.assertEqual(2, querySelectorAll(itemNode, rootNode).length, 'two items remain in list')
		}
	]);

	doh.run();

});
</script>
</head>
<body>

<form id="test">
	<fieldset style="display:none">
		<input name="first" value=""/>
		<input name="last" value=""/>
	</fieldset>
</form>

</body>
</html>